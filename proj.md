# 가상자산 조세포탈 대응 방안 구현 과정 (GraphSAGE 대체 버전)


## 1. 데이터 수집 및 변환 (T1 프로그램)

*   **목표**: 이더리움 ERC-20 토큰(PICA)의 전체 트랜잭션 데이터를 수집하고, 분석 가능한 형태로 변환합니다.
*   **데이터 소스**: PicaArtMoney(PICA) 토큰의 26,760개 트랜잭션 데이터. ERC-20 표준 인터페이스를 따르며, 송신자와 수신자 주소가 일대일로 대응되어 방향성 그래프 모델링에 적합합니다.
* 컬럼 : blockNumber,timeStamp,hash,nonce,blockHash,from,contractAddress,to,value,tokenName,tokenSymbol,tokenDecimal,transactionIndex,gas,gasPrice,gasUsed,cumulativeGasUsed,input,methodId,functionName,confirmations,amount
*   **수집 도구**: 이더스캔(Etherscan) API를 활용.
*   **T1 프로그램 기능**:
    *   API 요청 제한(최대 1만 건)으로 인한 블록 구간 분할 요청의 어려움을 해결하기 위해, **블록 구간을 자동으로 확인하고 분할하여 API 요청을 보냅니다**.
    *   수집된 데이터를 CSV 파일로 저장
*   **데이터 변환**: 이더스캔에서 수집된 `value`(거래 수량)는 `tokenDecimal` 값을 반영하여 소수점 자릿수를 조정해야 합니다.

## 2. 그래프 데이터베이스 모델링 및 구축 (T2 프로그램)

*   **목표**: 수집 및 변환된 블록체인 트랜잭션 데이터를 agensgraph 그래프 데이터베이스로 모델링하고 구축합니다.
*   **T2 프로그램 기능**: T1으로 생성된 SQLite DB 파일의 트랜잭션 데이터를 agensgraph 그래프 데이터베이스로 자동 모델링하고 구축합니다.
*   **그래프 설계 단계**:
    1.  **기본 설계**:
        *   **노드(Node)**: `addr` 노드는 지갑 주소(`address` 속성)를 의미하며, 트랜잭션 데이터의 `from` 값과 `to` 값을 사용합니다.
        *   **엣지(Edge)**: `FROM_TO` 엣지는 `txHash`, `value`, `gas`, `timestamp` 속성을 가지며, `from` 지갑 주소에서 `to` 지갑 주소로의 관계를 설정합니다. 동일한 주소 간 다수의 트랜잭션 발생 시, 횟수만큼 다수의 엣지가 생성됩니다.
    2.  **모델링 단순화**:
        *   직관적인 시각화와 분석 효율성을 위해 `addr` 노드 사이의 다수 `FROM_TO` 엣지를 하나의 **`NET_TO` 엣지**로 요약합니다.
        *   `NET_TO` 엣지는 순 거래 수량(`netValue`), 순 거래 횟수(`netCount`), 가장 빠른 시간(`earliestTimestamp`) 등의 속성을 가집니다.
    3.  **노드 속성 추가**:
        *   지갑 주소의 거래 패턴 분석을 위해 총 **37가지 속성**을 미리 계산하여 `addr` 노드에 추가합니다.
        *   주요 속성 예시: `uniqueEdgesIn`(유일 송신 엣지 개수), `uniqueEdgesOut`(유일 수신 엣지 개수), `dijkstra`(최단 경로 거리), `cycles`(순환 거래 수), `volatility`(트랜잭션 수량 변동성), `centralityBetweenness`(매개중심성), `centralityPagerank`(페이지랭크 중심성), `totCntIn`/`Out`(총 수신/송신 횟수), `totValIn`/`Out`(총 수신/송신 수량) 등.
    4.  **특수 거래 패턴 레이블 부여**:
        *   지갑 주소의 거래 유형을 시각화하고 압축적으로 표현하기 위해 10가지 레이블로 분류하고, 해당 지갑 주소 노드에 부여합니다.
        *   **레이블 종류 및 의미**:
            *   **`A_silkroad`**: 거래 수량이 상위 1% 이상인 노드 (대규모 거래 주체).
            *   **`B_pocket`**: 수신 트랜잭션만 있고 송신 트랜잭션은 없는 노드 (토큰 유통 경로의 종착지).
            *   **`C_bottleneck`**: 수신 거래는 많지만 송신 거래는 적은 병목 구조의 노드 (토큰 발행 및 유통에 중요한 역할).
            *   **`D_receiver`**: `C_bottleneck` 노드로부터 간접적으로 토큰을 전달받는 노드.
            *   **`E_passthrough`**: 수신 트랜잭션이 하나 이상 있고 송신 트랜잭션이 다수인 노드 (유통망의 분기점).
            *   **`F_supernode`**: 소규모 거래를 대량으로 발생시키는 `leaf` 노드 방향으로 다수의 송신 트랜잭션이 발생하는 노드 (소매 유통업자).
            *   **`G_genesis`**: 최초 트랜잭션의 송신 노드 (초기 물량 배분 추적).
            *   **`H_horizon`**: 최종 트랜잭션의 수신 노드 (전체 유통 구조 파악).
            *   **`I_identifier`**: 중앙화 거래소(CEX) 입금 전용 지갑 주소 유형 노드 (신원 확인 가능, 조세포탈 대응에 중요).
            *   **`X_exchange`**: n개 이상의 `I_identifier` 노드로부터 수신 거래가 있는 중앙화 거래소 관리 목적 지갑 주소 유형 노드.

## 3. AI 기반 그래프 데이터베이스 분석 (T3 프로그램)

*   **목표**: T2로 구축된 agensgraph 그래프 데이터베이스에 AI 기반 이상 거래 패턴 분석 방법을 적용하고, 그 결과를 엑셀 파일로 저장합니다.
*   **T3 프로그램 기능**: 그래프 데이터베이스에 **오토인코딩 기법을 사용한 GraphSAGE 모델**을 적용하여 지갑 주소별 이상 거래 패턴을 탐지하고, 이를 **XGBoost 모델**로 분석하여 이상 패턴의 원인을 정량적으로 평가합니다. **GraphSAGE로 대체 시, GAT의 어텐션 메커니즘 대신 이웃 노드를 랜덤 샘플링하고 평균/최대/합 등의 집계 함수로 특징을 추출하여 학습하므로, 대규모 그래프(예: 수십만 노드)에서 메모리 효율성과 속도가 향상됩니다. 그러나 GAT만큼 세밀한 이웃 중요도 학습이 약할 수 있으므로, 데이터 규모에 따라 성능을 테스트해야 합니다.**
*   **세부 구현 과정**:
    1.  **그래프 임베딩 (Node2Vec)**:
        *   **목적**: GraphSAGE 모델의 입력 데이터 생성을 위해, PICA 트랜잭션 데이터를 그래프로 변환한 후 Node2Vec 기법을 사용하여 노드의 35가지 속성 정보와 그래프 구조를 학습합니다.
        *   **결과**: 각 노드를 **64차원 벡터로 임베딩**합니다.
        *   **파라미터**: 임베딩 차원 64, 컨텍스트 윈도우 10, 최소 등장 횟수 1, 배치 크기 4. 랜덤 워크 설정: 길이 30, 횟수 200, 워커 수 4, p 및 q 값 1.
    2.  **그래프 신경망 모델 (GraphSAGE: Graph SAmple and aggreGatE)**:
        *   **모델 구조**: **오토인코더 구조(3개 층)**를 가지며, 비지도 학습으로 이상 패턴을 탐지합니다. **각 층에서 이웃 노드를 고정 크기로 샘플링(예: 10-25개)하고, 집계 함수(예: mean aggregator)를 적용하여 노드 특징을 업데이트합니다. 이는 GAT의 어텐션 기반 가중치 학습 대신 단순화된 접근으로, 확장성이 높습니다.**
        *   **작동 방식**:
            *   Node2Vec으로 생성된 **64차원 임베딩 벡터**를 입력으로 받습니다.
            *   **샘플링된 이웃 노드의 특징을 집계하여 노드 임베딩을 업데이트**하고, 그래프 구조를 학습합니다.
            *   차원 변환을 수행합니다 (64차원 → 256차원 → 32차원 → 64차원).
            *   입력 데이터를 재구성하고, **재구성된 벡터와 원본 입력 벡터 간의 오차(재구성 오차)**를 계산하여 이상 거래 패턴을 탐지합니다.
        *   **이상 패턴 탐지**: 재구성 오차가 클수록 비정상적 거래 패턴(자금세탁 관련 Peeling Chain, 순환 거래, 거래 폭발 등)을 보인다고 해석하며, 이는 조세포탈 위험 거래 탐지 지표로 활용됩니다.
        *   **이상 노드 구분**: 재구성 오차를 z-score로 정규화한 후, z-score 2(상위 5% 수준)를 초과하는 노드를 **이상 노드(Anomalous Node)**로 구분합니다.
        *   **모델 파라미터**: 최적화 알고리즘 Adam(학습률 0.001, 가중치 감쇠 0.0005), 손실 함수 MSE, 최대 에폭 500, 드롭아웃 비율 0.3, 활성화 함수 ELU. **추가로 샘플링 크기(예: [25, 10] for 2-hop)와 집계 함수(mean 또는 LSTM aggregator)를 지정해야 합니다.**
    3.  **머신러닝 모델 (XGBoost)**:
        *   **목적**: GraphSAGE 모델이 이상 노드를 구분하고 재구성 오차를 계산하는 데 영향을 미치는 주요 요인을 분석하고 정량적으로 평가합니다.
        *   **모델 종류**:
            *   **분류 모델(Classification Model)**: GraphSAGE 모델의 이상 노드 구분에 영향을 미치는 지갑 주소 노드의 주요 속성 분석.
            *   **회귀 모델(Regression Model)**: 재구성 오차 계산에 중요한 영향을 미치는 지갑 주소 노드의 주요 속성 분석.
        *   **설명 변수**:
            *   지갑 주소 노드의 35가지 속성 정보.
            *   10가지 특수 거래 패턴 레이블 해당 여부 (이진 값).
            *   Louvain 알고리즘으로 구분한 13가지 커뮤니티 해당 여부 (이진 값).
            *   그래프 임베딩 벡터와 중심성 벡터 간의 코사인 유사도.
            *   총 59가지 정보가 사용됩니다.
        *   **타깃 변수**:
            *   분류 모델: GraphSAGE 모델이 탐지한 재구성 오차에 따른 이상 노드 해당 여부(`anomaly_yn`).
            *   회귀 모델: GraphSAGE 모델이 탐지한 노드별 재구성 오차 측정값.
        *   **데이터 전처리**: 모든 설명 변수는 `StandardScaler`를 적용하여 정규화합니다.
        *   **학습 데이터**: 훈련 세트와 테스트 세트 8:2 비율로 분할. 분류 모델은 클래스 불균형 해결을 위해 `scale_pos_weight` 적용.
        *   **주요 분석 결과**:
            *   **매개중심성(`centralityBetweenness`)**: 이상 노드 구분 및 재구성 오차 계산에 가장 중요한 영향.
            *   **코사인 유사도(`cosine_similarity`)**: 단독으로 이상 패턴 구분에 영향, 다른 특성과의 상호작용으로 오분류 감소 및 새로운 이상 패턴 발견에 보조적 역할.
            *   **순환 거래 횟수(`cycles`)**: 비정상적인 순환 거래 횟수는 조세포탈 위험도가 높은 특징을 나타냄.
            *   **송신 트랜잭션 가스 허용량(`totGasOut`)**: 비정상적인 가스비 설정은 조세포탈 가능성 시사.
    4.  **T3 프로그램 출력 (엑셀 파일)**:
        *   **노드 분석 시트**: GraphSAGE 모델이 탐지한 지갑 주소별 재구성 오차, 이상 거래 패턴 여부, 35가지 속성 정보, 특수 거래 패턴 레이블, Node2Vec 임베딩 벡터 값, 코사인 유사도 등을 제공.
        *   **GraphSAGE 이상 거래 패턴 요인 분석 시트**: GraphSAGE 모델의 이상 노드 구분(분류 모델) 및 재구성 오차(회귀 모델)에 대한 **속성별 중요도(Importance)와 SHAP 값**을 제공하여 주요 영향 요인을 파악할 수 있도록 합니다.
        *   **XGBoost 속성별 모델 분석 시트**: 각 59가지 속성이 나머지 58가지 속성들과 어떤 상관관계를 가지는지 계산식(가중치)과 설명력(R²)을 통해 파악할 수 있도록 합니다.
        *   **커뮤니티 분석 시트**: 각 커뮤니티의 통계 값(중심 노드, 노드 개수, 밀도, 트랜잭션 횟수/수량 등)과 커뮤니티 조합 간 코사인 유사도 평균값 등을 제공하여 이상 패턴이 집중된 커뮤니티의 특성을 확인할 수 있습니다.
